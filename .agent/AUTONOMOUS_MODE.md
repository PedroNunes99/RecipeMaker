# Autonomous Mode Configuration

## Current State: Advisory Mode âœ…

Agents currently operate in **advisory mode** where they:
- âœ… Analyze tasks and provide detailed instructions
- âœ… Generate code snippets and configurations
- âœ… Suggest changes and improvements
- âŒ **Do NOT** automatically modify files
- âŒ **Do NOT** automatically execute commands

## Why Advisory Mode?

**Pros:**
- Safe - no unexpected file changes
- You maintain full control
- Review before implementing
- Perfect for learning and understanding

**Cons:**
- Manual implementation required
- Slower workflow
- Need to copy/paste code

---

## Enabling Full Autonomous Mode ðŸ¤–

To enable agents to automatically implement changes:

### Option 1: Tool-Enabled LLM (Recommended for Production)

Use Claude API (supports tool use):

```env
# .agent/.env
LLM_PROVIDER=anthropic
ANTHROPIC_API_KEY=your_api_key_here
AUTONOMOUS_MODE=true
```

### Option 2: Ollama with Function Calling

**Note:** Ollama doesn't natively support tool calling like Claude API does.

**Workaround Options:**

1. **Code Extraction Pattern** (Current Implementation)
   - Agents generate code in markdown blocks
   - Custom parser extracts and executes code
   - Set `AUTONOMOUS_MODE=semi` in `.env`

2. **Agent-as-Executor Pattern** (Manual)
   - Human reviews agent output
   - Human uses separate script to execute changes
   - Safest for local development

3. **Hybrid Approach** (Recommended for Ollama)
   - Agents provide instructions
   - Separate "Executor" agent (you or Claude Code) implements them
   - Best balance of safety and efficiency

---

## Configuration

### .agent/.env

```env
# Execution Mode
AUTONOMOUS_MODE=false        # false | semi | true
AUTO_EXECUTE_CODE=false      # Execute code generated by agents
AUTO_MODIFY_FILES=false      # Let agents modify files directly
REQUIRE_APPROVAL=true        # Ask before executing changes

# Safety Settings
MAX_FILE_CHANGES=10          # Max files per task
PROTECTED_PATHS=server/prisma/migrations,node_modules
DRY_RUN=false               # Simulate changes without executing
```

### Modes Explained

| Mode | Description | Use Case |
|------|-------------|----------|
| `false` | Advisory only - no execution | **Current** - Safe review mode |
| `semi` | Generate code, ask to execute | Balance of safety & speed |
| `true` | Full autonomy - auto execute | Production with monitoring |

---

## Implementation: Tool Execution System

To implement full autonomy, you need to:

### 1. Add Tool Executor to Base Agent

```javascript
// .agent/agents/base-agent.js

import { exec } from 'child_process';
import { promises as fs } from 'fs';

class BaseAgent {
  // ... existing code ...

  /**
   * Execute file write tool
   */
  async writeFile(path, content) {
    if (!process.env.AUTO_MODIFY_FILES) {
      this.logger.warn('AUTO_MODIFY_FILES is disabled');
      return { suggested: true, path, content };
    }

    await fs.writeFile(path, content, 'utf8');
    this.logger.info(`âœ“ File written: ${path}`);
    return { executed: true, path };
  }

  /**
   * Execute command tool
   */
  async executeCommand(command) {
    if (!process.env.AUTO_EXECUTE_CODE) {
      this.logger.warn('AUTO_EXECUTE_CODE is disabled');
      return { suggested: true, command };
    }

    return new Promise((resolve, reject) => {
      exec(command, (error, stdout, stderr) => {
        if (error) reject(error);
        else resolve({ stdout, stderr });
      });
    });
  }

  /**
   * Read file tool
   */
  async readFile(path) {
    const content = await fs.readFile(path, 'utf8');
    return { path, content };
  }
}
```

### 2. Update Agent Prompts

Modify agent system prompts to use tool calling format:

```javascript
getSystemPrompt() {
  return `You are a developer agent with access to tools.

Available tools:
- writeFile(path, content) - Write/create files
- readFile(path) - Read file contents
- executeCommand(cmd) - Run shell commands
- searchFiles(pattern) - Search codebase

When you want to use a tool, respond with:
TOOL: writeFile
PATH: client/src/test.js
CONTENT:
\`\`\`javascript
console.log('test');
\`\`\`

Always use tools to implement changes, don't just suggest.`;
}
```

### 3. Parse and Execute Tools

```javascript
async performTask(task) {
  const response = await this.callClaude(this.getSystemPrompt(), prompt);

  // Parse tool calls from response
  const toolCalls = this.extractToolCalls(response);

  // Execute tools if autonomous mode
  if (process.env.AUTONOMOUS_MODE === 'true') {
    for (const tool of toolCalls) {
      await this.executeTool(tool);
    }
  }

  return { response, toolCalls, executed: process.env.AUTONOMOUS_MODE };
}
```

---

## Safety Mechanisms

Even in autonomous mode, implement safety:

```javascript
class SafetyValidator {
  static validate(toolCall) {
    // Check if path is protected
    if (this.isProtectedPath(toolCall.path)) {
      throw new Error(`Cannot modify protected path: ${toolCall.path}`);
    }

    // Check file count limit
    if (this.fileChangeCount > process.env.MAX_FILE_CHANGES) {
      throw new Error('Max file changes reached');
    }

    // Validate command safety
    if (toolCall.command?.includes('rm -rf /')) {
      throw new Error('Dangerous command blocked');
    }
  }

  static isProtectedPath(path) {
    const protected = process.env.PROTECTED_PATHS.split(',');
    return protected.some(p => path.startsWith(p));
  }
}
```

---

## Current Workflow (Advisory Mode)

1. **Launch agents:** `cd .agent && node run-task.js`
2. **Agents analyze** and provide instructions
3. **You review** the output in logs
4. **You implement** changes manually or via Claude Code
5. **You test** and iterate

## Future Workflow (Autonomous Mode)

1. **Launch agents:** `cd .agent && node run-task.js`
2. **Agents analyze, implement, test** automatically
3. **You review** PR created by agents
4. **Merge** or request changes

---

## Recommendation

**For now, stick with Advisory Mode:**
- âœ… Safer during development
- âœ… Learn how agents think
- âœ… Understand changes before applying
- âœ… Works perfectly with Ollama
- âœ… You (or Claude Code) are the executor

**Switch to Autonomous Mode when:**
- You trust the agents' output
- You have good test coverage
- You're using Claude API (better tool support)
- You have monitoring set up

---

## Testing Autonomous Mode

Start with small, safe tasks:

```bash
# Enable semi-autonomous mode
echo "AUTONOMOUS_MODE=semi" >> .agent/.env

# Test with documentation task (safe)
node .agent/run-task.js --task="Update README.md with testing info"

# Review proposed changes
# Approve or reject execution
```

---

## Current Solution: Hybrid Approach âœ…

**Best practice with Ollama:**

1. **Agents** (DeepSeek Coder 33B) â†’ Generate instructions & code
2. **Claude Code** (You) â†’ Review and execute changes
3. **Auto-PR** â†’ Automatically create PRs after completion

This gives you:
- ðŸ¤– AI planning and code generation
- ðŸ‘€ Human review and approval
- âš¡ Fast iteration
- ðŸ”’ Safety and control

You're already using this approach successfully!
